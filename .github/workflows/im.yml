name: Build ImmortalWrt for OneCloud (Docker)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Shanghai
      DOCKER_IMAGE: ghcr.io/adjlevis/immortalwrt-imagebuilder:armsr-armv7-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½®æ—¶åŒºä¸ä¾èµ–
      - name: Setup environment
        run: |
          sudo timedatectl set-timezone "$TZ"
          sudo apt-get update -y
          sudo apt-get install -y gzip unzip xz-utils git bash

      # 3ï¸âƒ£ æ£€æŸ¥å·¥å…·æ–‡ä»¶
      - name: Check build tools
        run: |
          if [ ! -x "./tool/AmlImg_v0.3.1_linux_amd64" ]; then
            echo "âŒ ç¼ºå°‘ AmlImg_v0.3.1_linux_amd64 æˆ–æœªèµ‹äºˆæ‰§è¡Œæƒé™"
            exit 1
          fi
          if [ ! -f "./tool/eMMC.burn.img" ]; then
            echo "âŒ ç¼ºå°‘ eMMC.burn.img"
            exit 1
          fi
          echo "âœ… å·¥å…·æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      # 4ï¸âƒ£ æ‹‰å–æ„å»ºé•œåƒå¹¶æ„å»ºå›ºä»¶
      - name: Build ImmortalWrt firmware using Docker
        run: |
          echo "[INFO] === å¯åŠ¨ ImmortalWrt Docker æ„å»ºç¯å¢ƒ ==="
          docker pull $DOCKER_IMAGE
          docker run --rm -v "$(pwd)/immortalwrt:/home/build/immortalwrt" \
            -e TZ="$TZ" \
            $DOCKER_IMAGE \
            bash -c "cd /home/build/immortalwrt && ./build.sh"

      # 5ï¸âƒ£ æ”¶é›†ç¼–è¯‘äº§ç‰©
      - name: Collect build outputs
        run: |
          mkdir -p release/immortalwrt
          find immortalwrt/bin/targets/ -type f \( -name "*.img*" -o -name "*.bin" -o -name "*.tar.gz" \) -exec cp {} release/immortalwrt/ \;
          echo "âœ… å·²æ”¶é›†å›ºä»¶æ–‡ä»¶åˆ° release/immortalwrt"

      # 6ï¸âƒ£ æ‰“åŒ… Amlogic OneCloud ç›´åˆ·é•œåƒ
      - name: Package OneCloud eMMC burn image
        run: |
          echo "ğŸ§© å‡†å¤‡æ‰“åŒ… OneCloud ç›´åˆ·é•œåƒ..."
          cd immortalwrt/bin/targets/armsr/armv7/ || exit 1

          IMG_FILE=$(ls *rootfs*.img* 2>/dev/null | head -n 1 || true)
          if [[ -z "$IMG_FILE" ]]; then
            echo "âŒ æœªæ‰¾åˆ° rootfs é•œåƒæ–‡ä»¶ï¼ˆå¦‚ generic-ext4-rootfs.img.gzï¼‰"
            exit 1
          fi

          echo "ğŸ“¦ æ‰¾åˆ° rootfs é•œåƒ: $IMG_FILE"
          if [[ "$IMG_FILE" == *.gz ]]; then
            echo "ğŸ”§ è§£å‹ rootfs é•œåƒ..."
            gunzip -f "$IMG_FILE"
            IMG_FILE="${IMG_FILE%.gz}"
          fi

          chmod +x ../../../../tool/AmlImg_v0.3.1_linux_amd64
          echo "ğŸš€ ä½¿ç”¨ AmlImg å·¥å…·æ‰“åŒ…ç›´åˆ·é•œåƒ..."
          ../../../../tool/AmlImg_v0.3.1_linux_amd64 \
            -i "$IMG_FILE" \
            -b ../../../../tool/eMMC.burn.img \
            -o Onecloud-immortalwrt-ext4-emmc-burn.img

          echo "ğŸ—œï¸ å‹ç¼©ç›´åˆ·é•œåƒ..."
          gzip -f Onecloud-immortalwrt-ext4-emmc-burn.img
          mv Onecloud-immortalwrt-ext4-emmc-burn.img.gz ../../../../release/immortalwrt/

          echo "âœ… æ‰“åŒ…å®Œæˆï¼šrelease/immortalwrt/Onecloud-immortalwrt-ext4-emmc-burn.img.gz"

      # 7ï¸âƒ£ ä¸Šä¼ ç¼–è¯‘äº§ç‰©ä¸º Artifactï¼ˆå¯ä» Actions é¡µé¢ä¸‹è½½ï¼‰
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: OneCloud-ImmortalWrt
          path: release/immortalwrt/

      # 8ï¸âƒ£ ï¼ˆå¯é€‰ï¼‰è‡ªåŠ¨å‘å¸ƒ Release
      - name: Upload to GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "build-${{ github.run_number }}"
          name: "ImmortalWrt Build #${{ github.run_number }}"
          files: release/immortalwrt/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
