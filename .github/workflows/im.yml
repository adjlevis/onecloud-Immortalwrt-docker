name: OneCloud ImmortalWrt Build & Burn

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'  # 每天北京时间 03:00 自动构建

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ 拉取代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ 设置 Docker 环境
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ 授权 & 执行构建（在仓库根目录）
      - name: Run build
        run: |
          chmod +x ./immortalwrt/docker-build.sh
          ./immortalwrt/docker-build.sh

      # 4️⃣ 收集产物
      - name: Collect firmware
        run: |
          mkdir -p release/immortalwrt
          cp -r immortalwrt/bin/targets/armsr/armv7/* release/immortalwrt/
          ls -lh release/immortalwrt

      # 5️⃣ 上传产物
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OneCloud-ImmortalWrt
          path: release/immortalwrt

      # 6️⃣ 创建 Release
      - name: Get Time
        id: time
        run: echo "datetime=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Onecloud-${{ steps.time.outputs.datetime }}
          name: "OneCloud ImmortalWrt Build ${{ steps.time.outputs.datetime }}"
          body: |
            ✅ OneCloud ImmortalWrt 固件构建成功！
            包含线刷镜像 (Onecloud-immortalwrt-emmc-burn.img.gz)
          files: release/immortalwrt/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
