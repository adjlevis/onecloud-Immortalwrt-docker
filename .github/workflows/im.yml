name: OneCloud ImmortalWrt Full Build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *' # æ¯æ—¥åŒ—äº¬æ—¶é—´ 03:00 è‡ªåŠ¨æ„å»º

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ æ˜¾ç¤ºç›®å½•ç»“æ„
      - name: Show repository structure
        run: |
          echo "ğŸ“ å½“å‰ä»“åº“æ–‡ä»¶ç»“æ„ï¼š"
          ls -R

      # 3ï¸âƒ£ å‡†å¤‡ç¯å¢ƒ
      - name: Prepare environment
        run: |
          echo "ğŸ”§ å®‰è£…ä¾èµ–å¹¶å‡†å¤‡ç¯å¢ƒ..."
          sudo apt-get update
          sudo apt-get install -y dos2unix docker.io
          dos2unix immortalwrt/build.sh immortalwrt/docker-build.sh || true
          chmod +x immortalwrt/build.sh immortalwrt/docker-build.sh
          mkdir -p immortalwrt/bin immortalwrt/files release/immortalwrt
          sudo chmod -R 777 immortalwrt

      # 4ï¸âƒ£ æ‹‰å– ImmortalWrt ImageBuilder é•œåƒ
      - name: Pull ImmortalWrt ImageBuilder
        run: |
          docker pull immortalwrt/imagebuilder:armsr-armv7-24.10-SNAPSHOT

      # 5ï¸âƒ£ ä½¿ç”¨ ImageBuilder æ„å»º rootfs
      - name: Build rootfs.tar.gz using ImmortalWrt ImageBuilder
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º rootfs.tar.gz..."
          docker run --rm -v ${{ github.workspace }}/immortalwrt:/home/build/immortalwrt \
            immortalwrt/imagebuilder:armsr-armv7-24.10-SNAPSHOT \
            /bin/bash -c "cd /home/build/immortalwrt && ./build.sh"
          echo "âœ… rootfs æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºï¼š"
          find immortalwrt/bin -type f || true

      # 6ï¸âƒ£ æ‰“åŒ… OneCloud IMGï¼ˆè°ƒç”¨ ophub å·¥å…·ï¼‰
      - name: Pack OneCloud IMG using ophub/amlogic-s9xxx-openwrt
        run: |
          echo "ğŸ“¦ ä½¿ç”¨ ophub å·¥å…·æ‰“åŒ… OneCloud å›ºä»¶..."
          docker run --rm -v ${{ github.workspace }}/immortalwrt:/mnt \
            ophub/amlogic-s9xxx-openwrt \
            /bin/bash -c "
              cd /mnt && mkdir -p output &&
              cp bin/targets/armsr/armv7/openwrt-armvirt-64-default-rootfs.tar.gz ./rootfs.tar.gz &&
              ./tool/create-onecloud-img.sh ./rootfs.tar.gz ./output
            "
          echo "âœ… æ‰“åŒ…å®Œæˆï¼Œè¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š"
          ls -lh immortalwrt/output || true
          cp -r immortalwrt/output/* release/immortalwrt/ || true

      # 7ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onecloud-immortalwrt-images
          path: release/immortalwrt
          compression-level: 6
          if-no-files-found: warn

      # 8ï¸âƒ£ è·å–åŒ—äº¬æ—¶é—´
      - name: Get Beijing Time
        id: time
        run: |
          export TZ=Asia/Shanghai
          echo "datetime=$(date '+%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          echo "datetime_readable=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

      # 9ï¸âƒ£ å‘å¸ƒ Release
      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Onecloud-Immortalwrt-${{ steps.time.outputs.datetime }}
          name: "OneCloud Immortalwrt Build ${{ steps.time.outputs.datetime }}"
          body: |
            âœ… **OneCloud ImmortalWrt å›ºä»¶æ„å»ºæˆåŠŸï¼**

            ğŸ•“ æ„å»ºæ—¶é—´ï¼š${{ steps.time.outputs.datetime_readable }}
            ğŸ’¾ ä¸‹è½½åœ°å€ï¼š
            ğŸ‘‰ https://github.com/${{ github.repository }}/releases/tag/Onecloud-Immortalwrt-${{ steps.time.outputs.datetime }}
          files: release/immortalwrt/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ”Ÿ ä¿ç•™æœ€æ–° Release
      - name: Clean up old releases
        if: github.ref == 'refs/heads/main'
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          repo: ${{ github.repository }}
          keep_latest: 1
          delete_tag_pattern: "Onecloud-Immortalwrt-*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
