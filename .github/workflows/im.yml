name: OneCloud ImmortalWrt Build & Burn

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 03:00 è‡ªåŠ¨æ„å»º

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Docker ç¯å¢ƒ
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      # 3ï¸âƒ£ è°ƒè¯•ï¼šæŸ¥çœ‹æ–‡ä»¶ç»“æ„ï¼ˆå¯ç¡®è®¤è·¯å¾„ï¼‰
      - name: Debug file structure
        run: |
          echo "ğŸ“ å½“å‰ä»“åº“ç»“æ„å¦‚ä¸‹ï¼š"
          ls -R

      # 4ï¸âƒ£ ä¿®å¤è„šæœ¬æ ¼å¼å¹¶æˆæƒ
      - name: Prepare scripts
        run: |
          echo "ğŸ”§ ä¿®æ­£æ¢è¡Œç¬¦å¹¶è®¾ç½®æ‰§è¡Œæƒé™..."
          sudo apt-get update && sudo apt-get install -y dos2unix

          # è½¬æ¢è„šæœ¬ä¸º Linux æ ¼å¼
          dos2unix ./immortalwrt/docker-build.sh || true
          dos2unix ./immortalwrt/build.sh || true

          chmod +x ./immortalwrt/docker-build.sh ./immortalwrt/build.sh
          echo "âœ… è„šæœ¬çŠ¶æ€ï¼š"
          file ./immortalwrt/docker-build.sh ./immortalwrt/build.sh

      # 5ï¸âƒ£ æ‹‰å– ImageBuilderï¼ˆæ¨è armv7 ç‰ˆæœ¬ï¼‰
      - name: Pull ImmortalWrt ImageBuilder
        run: |
          docker pull immortalwrt/imagebuilder:armsr-armv7-24.10-SNAPSHOT

      # 6ï¸âƒ£ æ‰§è¡Œæ„å»ºï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
      - name: Run build
        run: |
          echo "ğŸš€ å¯åŠ¨ ImmortalWrt Docker æ„å»º..."
          bash ./immortalwrt/docker-build.sh

      # 7ï¸âƒ£ æ”¶é›†äº§ç‰©
      - name: Collect firmware
        run: |
          echo "ğŸ“¦ æ”¶é›†å›ºä»¶äº§ç‰©..."
          mkdir -p release/immortalwrt
          cp -r immortalwrt/bin/targets/armsr/armv7/* release/immortalwrt/ 2>/dev/null || true
          echo "âœ… äº§ç‰©åˆ—è¡¨ï¼š"
          ls -lh release/immortalwrt || true

      # 8ï¸âƒ£ è‡ªåŠ¨ç”Ÿæˆ OneCloud çº¿åˆ·åŒ…
      - name: Make OneCloud burnable image
        run: |
          echo "ğŸ”¥ å¼€å§‹ç”Ÿæˆ OneCloud eMMC çº¿åˆ·é•œåƒ..."
          cd release/immortalwrt || exit 1

          ROOTFS_IMG=$(ls *rootfs*.img.gz 2>/dev/null | head -n 1 || true)
          if [[ -z "$ROOTFS_IMG" ]]; then
            echo "âŒ æœªæ‰¾åˆ° rootfs é•œåƒ (*.rootfs.img.gz)"
            ls -lh
            exit 1
          fi

          echo "ğŸ§© æ‰¾åˆ° rootfs é•œåƒ: $ROOTFS_IMG"
          gunzip -f "$ROOTFS_IMG"
          ROOTFS_IMG="${ROOTFS_IMG%.gz}"

          TOOL_PATH="../../tool/AmlImg_v0.3.1_linux_amd64"
          BURN_IMG="../../tool/eMMC.burn.img"

          if [[ ! -x "$TOOL_PATH" ]]; then
            chmod +x "$TOOL_PATH"
          fi

          if [[ ! -f "$BURN_IMG" ]]; then
            echo "âŒ æ‰¾ä¸åˆ°æ¨¡æ¿ eMMC.burn.img"
            exit 1
          fi

          "$TOOL_PATH" -i "$ROOTFS_IMG" -b "$BURN_IMG" -o Onecloud-immortalwrt-emmc-burn.img
          gzip -f Onecloud-immortalwrt-emmc-burn.img

          echo "âœ… çº¿åˆ·åŒ…ç”Ÿæˆå®Œæˆï¼š"
          ls -lh

      # 9ï¸âƒ£ ä¸Šä¼ äº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OneCloud-ImmortalWrt
          path: release/immortalwrt

      # ğŸ”Ÿ è·å–æ„å»ºæ—¶é—´
      - name: Get Time
        id: time
        run: echo "datetime=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

      # 1ï¸âƒ£1ï¸âƒ£ å‘å¸ƒåˆ° GitHub Release
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Onecloud-${{ steps.time.outputs.datetime }}
          name: "OneCloud ImmortalWrt Build ${{ steps.time.outputs.datetime }}"
          body: |
            âœ… **OneCloud ImmortalWrt å›ºä»¶æ„å»ºæˆåŠŸï¼**

            åŒ…å«è‡ªåŠ¨å°è£…çš„çº¿åˆ·é•œåƒï¼š
            `Onecloud-immortalwrt-emmc-burn.img.gz`
          files: release/immortalwrt/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
