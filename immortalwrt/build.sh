#!/bin/bash
#=================================================
# OneCloud ImmortalWrt å›ºä»¶æ„å»ºè„šæœ¬
# åœ¨ Docker é•œåƒä¸­æ‰§è¡Œï¼ˆç”± docker-build.sh è°ƒç”¨ï¼‰
#=================================================
set -euxo pipefail

echo "[Build] ğŸš€ å¼€å§‹æ„å»º OneCloud ImmortalWrt å›ºä»¶..."

#-----------------------------------------------
# å¯é€‰ï¼šæ¸…ç†ä¸Šæ¬¡æ„å»ºç¼“å­˜
#-----------------------------------------------
rm -rf bin/ || true
mkdir -p bin/

#-----------------------------------------------
# è½¯ä»¶åŒ…å®šä¹‰ï¼ˆå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰
#-----------------------------------------------
PACKAGES="curl \
luci-i18n-base-zh-cn \
luci-i18n-firewall-zh-cn \
luci-i18n-opkg-zh-cn \
luci-i18n-upnp-zh-cn \
luci-app-upnp \
luci-app-firewall"

#-----------------------------------------------
# è°ƒç”¨ ImageBuilder æ„å»ºé•œåƒ
#-----------------------------------------------
make image \
  PROFILE="generic" \
  PACKAGES="$PACKAGES" \
  EXTRA_IMAGE_NAME="ext4-emmc-burn" \
  EXTRA_IMAGE_FORMATS="ext4.gz img.gz" \
  ROOTFS_PARTSIZE=512

#-----------------------------------------------
# è¾“å‡ºæ£€æŸ¥
#-----------------------------------------------
echo "[Build] âœ… å›ºä»¶æ„å»ºå®Œæˆï¼Œè¾“å‡ºæ–‡ä»¶ï¼š"
find bin/targets -type f \( -name "*.img*" -or -name "*.ext4*" \) || true

#-----------------------------------------------
# æç¤ºä¸‹ä¸€æ­¥
#-----------------------------------------------
echo "[Build] ğŸ“¦ å›ºä»¶æ„å»ºç»“æŸï¼Œå¯åœ¨åç»­æ­¥éª¤æ‰“åŒ… eMMC ç›´åˆ·é•œåƒã€‚"
