#!/bin/bash
#=================================================
# OneCloud ImmortalWrt å›ºä»¶æ„å»ºè„šæœ¬
# åœ¨ Docker é•œåƒä¸­æ‰§è¡Œï¼ˆç”± docker-build.sh è°ƒç”¨ï¼‰
#=================================================
set -euxo pipefail

echo "[Build] ğŸš€ å¼€å§‹æ„å»º OneCloud ImmortalWrt å›ºä»¶..."

#-----------------------------------------------
# ğŸ§¹ æ¸…ç†æ—§æ„å»ºç¼“å­˜
#-----------------------------------------------
rm -rf bin/ || true
mkdir -p bin/

#-----------------------------------------------
# ğŸ“¦ å®šä¹‰è¦å®‰è£…çš„åŒ…ï¼ˆå¯è‡ªè¡Œå¢åˆ ï¼‰
#-----------------------------------------------
PACKAGES="curl \
luci-i18n-base-zh-cn \
luci-i18n-firewall-zh-cn \
luci-i18n-opkg-zh-cn \
luci-i18n-upnp-zh-cn \
luci-app-upnp \
luci-app-firewall"

#-----------------------------------------------
# âš™ï¸ æ‰§è¡Œ ImageBuilder æ„å»º
#-----------------------------------------------
make image \
  PROFILE="generic" \
  PACKAGES="$PACKAGES" \
  EXTRA_IMAGE_NAME="ext4-emmc-burn" \
  EXTRA_IMAGE_FORMATS="ext4.gz img.gz" \
  ROOTFS_PARTSIZE=512

#-----------------------------------------------
# âœ… è¾“å‡ºæ£€æŸ¥
#-----------------------------------------------
echo "[Build] âœ… å›ºä»¶æ„å»ºå®Œæˆï¼Œè¾“å‡ºæ–‡ä»¶å¦‚ä¸‹ï¼š"
find bin/targets -type f \( -name "*.img*" -or -name "*.ext4*" \) || true

#-----------------------------------------------
# ğŸ“¦ ç»“æŸæç¤º
#-----------------------------------------------
echo "[Build] ğŸ¯ æ„å»ºå·²å®Œæˆï¼Œå¯åœ¨åç»­æ­¥éª¤æ‰“åŒ… eMMC ç›´åˆ·é•œåƒã€‚"
